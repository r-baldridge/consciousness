# API Gateway Configuration
# Defines endpoints, security, and operational parameters

version: "1.0.0"

server:
  host: "0.0.0.0"
  port: 8000
  workers: 4
  timeout_seconds: 30
  max_connections: 100
  keepalive_timeout: 5

api:
  version: "v1"
  base_path: "/api/v1"
  title: "Neural Network Consciousness API"
  description: "API for coordinating local AI models across 27 consciousness forms"

# Endpoint configurations
endpoints:
  # System Health
  health:
    path: "/health"
    methods: ["GET"]
    rate_limit: 100
    timeout_ms: 1000
    description: "System health check"

  metrics:
    path: "/metrics"
    methods: ["GET"]
    rate_limit: 60
    timeout_ms: 5000
    description: "Prometheus-compatible metrics"
    format: "prometheus"

  resources:
    path: "/resources"
    methods: ["GET"]
    rate_limit: 60
    timeout_ms: 2000
    description: "Current resource utilization"

  # Form Management
  forms_list:
    path: "/forms"
    methods: ["GET"]
    rate_limit: 60
    timeout_ms: 2000
    description: "List all forms with status"

  form_detail:
    path: "/forms/{form_id}"
    methods: ["GET"]
    rate_limit: 120
    timeout_ms: 2000
    description: "Get form details and status"

  form_load:
    path: "/forms/{form_id}/load"
    methods: ["POST"]
    rate_limit: 30
    timeout_ms: 30000
    description: "Load form model into memory"

  form_unload:
    path: "/forms/{form_id}/unload"
    methods: ["POST"]
    rate_limit: 30
    timeout_ms: 10000
    description: "Unload form model from memory"

  # Inference
  inference_single:
    path: "/inference/{form_id}"
    methods: ["POST"]
    rate_limit: 1000
    timeout_ms: 5000
    description: "Single form inference"
    max_payload_bytes: 10485760  # 10MB

  inference_batch:
    path: "/inference/batch"
    methods: ["POST"]
    rate_limit: 100
    timeout_ms: 30000
    description: "Multi-form batch inference"
    max_payload_bytes: 52428800  # 50MB
    max_batch_size: 10

  # Message Bus
  message_publish:
    path: "/messages/publish"
    methods: ["POST"]
    rate_limit: 1000
    timeout_ms: 1000
    description: "Publish message to bus"

  message_subscribe:
    path: "/messages/subscribe"
    methods: ["POST"]
    rate_limit: 100
    timeout_ms: 5000
    description: "Subscribe to message channel"

  # WebSocket Streaming
  stream_consciousness:
    path: "/stream/consciousness"
    type: "websocket"
    max_connections: 50
    heartbeat_interval_ms: 30000
    description: "Real-time consciousness state stream"

  stream_form:
    path: "/stream/forms/{form_id}"
    type: "websocket"
    max_connections: 100
    heartbeat_interval_ms: 30000
    description: "Form-specific real-time updates"

  stream_global_workspace:
    path: "/stream/global-workspace"
    type: "websocket"
    max_connections: 50
    heartbeat_interval_ms: 30000
    description: "Global workspace state stream"

# Rate limiting
rate_limiting:
  enabled: true
  strategy: "sliding_window"
  window_size_seconds: 60
  headers:
    limit: "X-RateLimit-Limit"
    remaining: "X-RateLimit-Remaining"
    reset: "X-RateLimit-Reset"

# CORS configuration
cors:
  enabled: true
  allow_origins: ["*"]
  allow_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
  allow_headers: ["*"]
  expose_headers: ["X-Request-ID", "X-RateLimit-Limit", "X-RateLimit-Remaining"]
  max_age: 600

# Security
security:
  api_key:
    enabled: false
    header: "X-API-Key"
  jwt:
    enabled: false
    algorithm: "HS256"
    expiry_seconds: 3600
  request_validation:
    enabled: true
    max_body_size_bytes: 52428800  # 50MB

# Logging
logging:
  level: "INFO"
  format: "json"
  include_request_id: true
  log_requests: true
  log_responses: false
  sensitive_fields: ["api_key", "token", "password"]

# Request/Response
request:
  default_timeout_ms: 5000
  max_timeout_ms: 60000
  request_id_header: "X-Request-ID"

response:
  compression:
    enabled: true
    algorithms: ["gzip", "br"]
    min_size_bytes: 1024
  headers:
    cache_control: "no-cache, no-store, must-revalidate"
    content_type: "application/json"

# Error handling
errors:
  include_stack_trace: false
  include_details: true
  error_codes:
    validation_error: 400
    authentication_error: 401
    authorization_error: 403
    not_found: 404
    rate_limit_exceeded: 429
    internal_error: 500
    service_unavailable: 503

# WebSocket configuration
websocket:
  ping_interval_seconds: 30
  ping_timeout_seconds: 10
  max_message_size_bytes: 1048576  # 1MB
  close_timeout_seconds: 5

# Streaming data configuration
streaming:
  consciousness_stream:
    update_rate_hz: 10
    include_arousal: true
    include_global_workspace: true
    include_phi_value: true
    include_active_forms: true

  form_stream:
    update_rate_hz: 20
    include_state: true
    include_outputs: true
    include_metrics: true
