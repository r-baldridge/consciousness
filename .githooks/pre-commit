#!/bin/bash
#
# Pre-commit hook for PII detection
# Prevents commits containing personally identifiable information
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ðŸ” Running PII security scan..."

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No files to check${NC}"
    exit 0
fi

PII_FOUND=0
WARNINGS=0

# =============================================================================
# PII PATTERNS TO DETECT
# =============================================================================

# Email patterns (personal email domains)
check_personal_emails() {
    local pattern='@(gmail|yahoo|hotmail|outlook|icloud|protonmail|aol|live|msn)\.'
    if echo "$STAGED_FILES" | xargs grep -l -E -i "$pattern" 2>/dev/null; then
        echo -e "${RED}âš  Personal email addresses detected${NC}"
        echo "$STAGED_FILES" | xargs grep -n -E -i "$pattern" 2>/dev/null || true
        return 1
    fi
    return 0
}

# Local machine paths with usernames
check_local_paths() {
    local pattern='/Users/[a-zA-Z]+/|/home/[a-zA-Z]+/|C:\\Users\\[a-zA-Z]+'
    if echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null; then
        echo -e "${RED}âš  Local file paths with usernames detected${NC}"
        echo "$STAGED_FILES" | xargs grep -n -E "$pattern" 2>/dev/null || true
        return 1
    fi
    return 0
}

# Phone numbers (US format)
check_phone_numbers() {
    # Exclude known safe numbers (SAMHSA helpline, etc.)
    local pattern='\b[0-9]{3}[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}\b'
    local safe_numbers='1-800-662-4357|800-662-4357|988|911'

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            matches=$(grep -n -E "$pattern" "$file" 2>/dev/null | grep -v -E "$safe_numbers" || true)
            if [ -n "$matches" ]; then
                echo -e "${YELLOW}âš  Potential phone numbers in $file (verify these are not personal):${NC}"
                echo "$matches"
                WARNINGS=$((WARNINGS + 1))
            fi
        fi
    done
}

# Social Security Numbers
check_ssn() {
    local pattern='\b[0-9]{3}-[0-9]{2}-[0-9]{4}\b'
    if echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null; then
        echo -e "${RED}âš  Potential SSN pattern detected${NC}"
        echo "$STAGED_FILES" | xargs grep -n -E "$pattern" 2>/dev/null || true
        return 1
    fi
    return 0
}

# API keys and secrets (common patterns)
check_api_keys() {
    local patterns=(
        'sk-[a-zA-Z0-9]{20,}'           # OpenAI style
        'ghp_[a-zA-Z0-9]{36}'           # GitHub PAT
        'gho_[a-zA-Z0-9]{36}'           # GitHub OAuth
        'github_pat_[a-zA-Z0-9_]{22,}'  # GitHub fine-grained PAT
        'xox[baprs]-[a-zA-Z0-9-]+'      # Slack tokens
        'AKIA[0-9A-Z]{16}'              # AWS Access Key
        'AIza[0-9A-Za-z_-]{35}'         # Google API Key
    )

    for pattern in "${patterns[@]}"; do
        if echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null; then
            echo -e "${RED}âš  Potential API key/secret detected (pattern: $pattern)${NC}"
            echo "$STAGED_FILES" | xargs grep -n -E "$pattern" 2>/dev/null || true
            return 1
        fi
    done
    return 0
}

# Private keys
check_private_keys() {
    local pattern='-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----'
    if echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null; then
        echo -e "${RED}âš  Private key detected${NC}"
        return 1
    fi
    return 0
}

# Custom name patterns (add your name variations here)
check_custom_names() {
    # Load patterns from .pii-patterns file if it exists
    if [ -f ".pii-patterns" ]; then
        while IFS= read -r pattern || [ -n "$pattern" ]; do
            # Skip comments and empty lines
            [[ "$pattern" =~ ^#.*$ ]] && continue
            [[ -z "$pattern" ]] && continue

            if echo "$STAGED_FILES" | xargs grep -l -i -E "$pattern" 2>/dev/null; then
                echo -e "${RED}âš  Custom PII pattern detected: $pattern${NC}"
                echo "$STAGED_FILES" | xargs grep -n -i -E "$pattern" 2>/dev/null || true
                PII_FOUND=1
            fi
        done < ".pii-patterns"
    fi
}

# IP addresses (excluding common safe ones)
check_ip_addresses() {
    local pattern='\b([0-9]{1,3}\.){3}[0-9]{1,3}\b'
    local safe_ips='0\.0\.0\.0|127\.0\.0\.1|localhost|192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.'

    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            matches=$(grep -n -E "$pattern" "$file" 2>/dev/null | grep -v -E "$safe_ips" || true)
            if [ -n "$matches" ]; then
                echo -e "${YELLOW}âš  Public IP addresses in $file (verify these are not personal):${NC}"
                echo "$matches"
                WARNINGS=$((WARNINGS + 1))
            fi
        fi
    done
}

# =============================================================================
# GIT AUTHOR CHECK
# =============================================================================

check_git_author() {
    local author_name=$(git config user.name)
    local author_email=$(git config user.email)

    # Check if using noreply email - if so, skip pattern checks (already anonymized)
    if [[ "$author_email" =~ noreply ]]; then
        return 0
    fi

    echo -e "${YELLOW}âš  Git email does not use noreply format: $author_email${NC}"
    echo "  Consider using: git config user.email 'username@users.noreply.github.com'"
    WARNINGS=$((WARNINGS + 1))

    # Check against custom patterns
    if [ -f ".pii-patterns" ]; then
        while IFS= read -r pattern || [ -n "$pattern" ]; do
            [[ "$pattern" =~ ^#.*$ ]] && continue
            [[ -z "$pattern" ]] && continue

            if echo "$author_name $author_email" | grep -i -E "$pattern" > /dev/null 2>&1; then
                echo -e "${RED}âš  Git author matches PII pattern: $pattern${NC}"
                echo "  Author: $author_name <$author_email>"
                PII_FOUND=1
            fi
        done < ".pii-patterns"
    fi
}

# =============================================================================
# RUN CHECKS
# =============================================================================

echo "Checking staged files for PII..."

check_personal_emails || PII_FOUND=1
check_local_paths || PII_FOUND=1
check_ssn || PII_FOUND=1
check_api_keys || PII_FOUND=1
check_private_keys || PII_FOUND=1
check_custom_names
check_phone_numbers
check_ip_addresses
check_git_author

# =============================================================================
# RESULTS
# =============================================================================

echo ""
if [ $PII_FOUND -eq 1 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âœ— COMMIT BLOCKED: PII detected in staged files${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Please remove or replace the PII before committing."
    echo "To bypass this check (not recommended): git commit --no-verify"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}âš  WARNINGS: $WARNINGS potential PII items found (review above)${NC}"
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Proceeding with commit. Review warnings if needed."
fi

echo -e "${GREEN}âœ“ PII scan complete${NC}"
exit 0
